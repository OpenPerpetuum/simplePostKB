{%extends "base.html"%}
{%block nav%}
{%include 'nav.html'%}
{%endblock%}

{%block content%}




<div class="row">
	<div class = "col-xs-12 text-center">
	<!--
		<form method="post" action="/postkill">
			{% csrf_token %}
		    {{ formset }}
		   <button type="submit" class="btn btn-primary">Submit</button>
		</form>
-->
		<form id="killform" method="post" action="/postkill">
			{% csrf_token %}
		    {{ formset }}
		   <button type="submit" class="btn btn-primary">Submit</button>
		</form>

		<form id="previewform" method="post" action="/postkill">
			{% csrf_token %}
		    {{ modelform }}
		   <button type="submit" class="btn btn-primary">Submit</button>
		</form>

	</div>
</div>

<script type="text/javascript">
$("#killform").submit(function(e){
	var form = this;
	e.preventDefault();
	console.log(e);
	var content = $("#id_content").val();
	var out = parseContent(content);
	console.log(out);
	out["csrfmiddlewaretoken"] = '{{ csrf_token }}' ; 
	$.post("/postkill", out);
});

function findNextEmptyLine(lines, currentindex){
	for(var i=currentindex; i<lines.length; i++){
		if(lines[i].length==0){
			return i;
		}
	}
	return lines.length;
}

function getRangeAsDict(lines, start, end){
	console.log("parsing from "+ start + " to "+end);
	var dict = {};
	for(var i=start; i<end; i++){
		if(lines[i].includes(":")){
			var keyval = lines[i].split(":");
			dict[keyval[0]] = keyval[1];
		}else if(lines[i].includes("*Killing blow*")){
			dict["Killing blow"] = true;
		}else{
			dict = lines[i];
		}
	}
	console.log(dict);
	return dict;
}

function parseContent(raw){
	var lines = raw.split("\n");
	console.log(lines);
	var kill = {};
	var dict = {};
	for(var i=0; i<lines.length; i++){
		if(i==0){
			dict[lines[0]] = lines[1];
		}else if(lines[i].length==0){
			i++;
			if(lines[i]=="Attackers"){
				i++;
			}
			if(!lines[i].includes(":")){
				var key = lines[i];
				i++;
			}
			var end = findNextEmptyLine(lines, i);
			dict[key] = getRangeAsDict(lines, i, end);
		}
	}
	return dict;
}
</script>

{% load staticfiles %}


{%endblock%}
